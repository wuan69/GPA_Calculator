<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T√≠nh GPA h·ªçc k·ª≥</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e6f0fa;
      color: #1a1a2e;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
    }
    header {
      background: #4682b4;
      color: white;
      text-align: center;
      padding: 10px 0;
      margin-bottom: 20px;
      border-radius: 0 0 12px 12px;
    }
    h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      max-width: 700px;
      margin: 0 auto;
    }
    label {
      display: block;
      margin: 12px 0 6px 0;
      font-weight: 600;
    }
    input[type="number"], input[type="text"] {
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 8px 12px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
      transition: 0.3s;
      outline: none;
    }
    input[type="number"]:focus, input[type="text"]:focus {
      border-color: #4682b4;
      box-shadow: 0 0 5px rgba(70, 130, 180, 0.3);
    }
    button {
      background: #4682b4;
      color: white;
      cursor: pointer;
      font-weight: 600;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      transition: background 0.3s;
      width: 100%;
      margin-top: 15px;
    }
    button:hover {
      background: #4169e1;
    }
    .subjects-container {
      margin-top: 20px;
    }
    .subject-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .subject-row input {
      flex: 1;
    }
    .subject-row input[type="text"] {
      flex: 2;
    }
    h3 {
      font-size: 1.1rem;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .result {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      max-width: 700px;
      margin: 20px auto;
      color: #4682b4;
      line-height: 1.5;
    }
    .result strong {
      color: #4682b4;
    }
    ul {
      list-style-type: disc;
      padding-left: 20px;
    }
    li {
      margin-bottom: 8px;
      font-size: 1rem;
    }
    #gpaChart {
      max-width: 300px;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìä T√≠nh GPA h·ªçc k·ª≥</h1>
  </header>
  <div class="container">
    <label for="numLearned">S·ªë m√¥n ƒë√£ h·ªçc <span style="color:red">*</span>:</label>
    <input type="number" min="0" id="numLearned" value="0" />
    <label for="numNotLearned">S·ªë m√¥n ch∆∞a h·ªçc (kh√¥ng b·∫Øt bu·ªôc):</label>
    <input type="number" min="0" id="numNotLearned" value="0" />
    <button id="generateBtn">Hi·ªÉn th·ªã b·∫£ng nh·∫≠p ƒëi·ªÉm</button>
    <form id="subjectsForm" style="display:none;">
      <div id="learnedSubjects" class="subjects-container">
        <h3>M√¥n ƒë√£ h·ªçc (b·∫Øt bu·ªôc nh·∫≠p t√™n, t√≠n ch·ªâ, ƒëi·ªÉm t·ªïng k·∫øt):</h3>
      </div>
      <div id="notLearnedSubjects" class="subjects-container" style="display:none;">
        <h3>M√¥n ch∆∞a h·ªçc (nh·∫≠p t√™n, t√≠n ch·ªâ; ƒëi·ªÉm ƒë·ªÉ tr·ªëng):</h3>
      </div>
      <label for="targetGpa">M·ª•c ti√™u GPA (thang 4.0 ho·∫∑c ch·ªØ A+, A, B+, ...):</label>
      <input type="text" id="targetGpa" placeholder="V√≠ d·ª•: 3.0 ho·∫∑c B+" />
      <button type="submit">T√≠nh GPA</button>
    </form>
    <div id="result" class="result" style="display:none;">
      <canvas id="gpaChart"></canvas>
    </div>
  </div>
  <script>
    // Chuy·ªÉn ƒëi·ªÉm 10 sang 4.0
    function convert10To4(score10) {
      if (score10 >= 9.5) return 4.0;      // A+
      if (score10 >= 8.5) return 3.8;      // A
      if (score10 >= 8.0) return 3.5;      // B+
      if (score10 >= 7.0) return 3.0;      // B
      if (score10 >= 6.5) return 2.5;      // C+
      if (score10 >= 5.5) return 2.0;      // C
      if (score10 >= 5.0) return 1.5;      // D+
      if (score10 >= 4.0) return 1.0;      // D
      return 0.0;                          // F
    }

    // Chuy·ªÉn ch·ªØ (A+, A, B+, B, ...) sang ƒëi·ªÉm GPA s·ªë
    function convertLetterToGPA(letter) {
      const map = {
        "A+": 4.0,
        "A": 3.8,
        "B+": 3.5,
        "B": 3.0,
        "C+": 2.5,
        "C": 2.0,
        "D+": 1.5,
        "D": 1.0,
        "F": 0.0,
      };
      letter = letter.toUpperCase().trim();
      return map[letter] !== undefined ? map[letter] : NaN;
    }

    // Chuy·ªÉn s·ªë GPA th√†nh nh√£n ch·ªØ
    function gpaLabel(gpa) {
      if (gpa >= 3.9) return "A+";
      if (gpa >= 3.8) return "A";
      if (gpa >= 3.5) return "B+";
      if (gpa >= 3.0) return "B";
      if (gpa >= 2.5) return "C+";
      if (gpa >= 2.0) return "C";
      if (gpa >= 1.5) return "D+";
      if (gpa >= 1.0) return "D";
      return "F";
    }

    // Chuy·ªÉn GPA th√†nh ƒëi·ªÉm thang 10 (d√πng ƒë·ªÉ hi·ªÉn th·ªã k·∫øt qu·∫£)
    function convertGpaTo10(gpa) {
      if (gpa >= 4.0) return 9.5;
      if (gpa >= 3.8) return 8.5;
      if (gpa >= 3.5) return 8.0;
      if (gpa >= 3.0) return 7.0;
      if (gpa >= 2.5) return 6.5;
      if (gpa >= 2.0) return 5.5;
      if (gpa >= 1.5) return 5.0;
      if (gpa >= 1.0) return 4.0;
      return 2.5;
    }

    const numLearnedInput = document.getElementById("numLearned");
    const numNotLearnedInput = document.getElementById("numNotLearned");
    const generateBtn = document.getElementById("generateBtn");
    const subjectsForm = document.getElementById("subjectsForm");
    const learnedSubjectsDiv = document.getElementById("learnedSubjects");
    const notLearnedSubjectsDiv = document.getElementById("notLearnedSubjects");
    const resultDiv = document.getElementById("result");
    const targetGpaInput = document.getElementById("targetGpa");
    let chartInstance = null;

    function createSubjectRow(withScore) {
      const row = document.createElement("div");
      row.classList.add("subject-row");

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "T√™n m√¥n (c√≥ th·ªÉ vi·∫øt t·∫Øt)";
      nameInput.required = true;
      row.appendChild(nameInput);

      const creditInput = document.createElement("input");
      creditInput.type = "number";
      creditInput.placeholder = "T√≠n ch·ªâ";
      creditInput.min = "0.5";
      creditInput.step = "0.5";
      creditInput.required = true;
      row.appendChild(creditInput);

      if (withScore) {
        const scoreInput = document.createElement("input");
        scoreInput.type = "number";
        scoreInput.placeholder = "ƒêi·ªÉm t·ªïng k·∫øt (0-10)";
        scoreInput.min = "0";
        scoreInput.max = "10";
        scoreInput.step = "0.1";
        scoreInput.required = true;
        row.appendChild(scoreInput);
      }

      return row;
    }

    function saveSubjectData(container) {
      const rows = container.querySelectorAll(".subject-row");
      return Array.from(rows).map(row => {
        const inputs = row.querySelectorAll("input");
        return {
          name: inputs[0].value,
          credit: inputs[1].value,
          score: inputs.length > 2 ? inputs[2].value : ""
        };
      });
    }

    function restoreSubjectData(container, data, withScore) {
      container.innerHTML = withScore
        ? "<h3>M√¥n ƒë√£ h·ªçc (b·∫Øt bu·ªôc nh·∫≠p t√™n, t√≠n ch·ªâ, ƒëi·ªÉm t·ªïng k·∫øt):</h3>"
        : "<h3>M√¥n ch∆∞a h·ªçc (nh·∫≠p t√™n, t√≠n ch·ªâ; ƒëi·ªÉm ƒë·ªÉ tr·ªëng):</h3>";
      data.forEach(item => {
        const row = createSubjectRow(withScore);
        const inputs = row.querySelectorAll("input");
        inputs[0].value = item.name || "";
        inputs[1].value = item.credit || "";
        if (withScore && inputs[2]) inputs[2].value = item.score || "";
        container.appendChild(row);
      });
    }

    function updateSubjectRows() {
      const nLearned = parseInt(numLearnedInput.value) || 0;
      const nNotLearned = parseInt(numNotLearnedInput.value) || 0;

      if (nLearned <= 0) {
        alert("Vui l√≤ng nh·∫≠p s·ªë m√¥n ƒë√£ h·ªçc l·ªõn h∆°n 0.");
        return false;
      }

      // Save existing data
      const learnedData = saveSubjectData(learnedSubjectsDiv);
      const notLearnedData = saveSubjectData(notLearnedSubjectsDiv);

      // Clear containers
      learnedSubjectsDiv.innerHTML = "<h3>M√¥n ƒë√£ h·ªçc (b·∫Øt bu·ªôc nh·∫≠p t√™n, t√≠n ch·ªâ, ƒëi·ªÉm t·ªïng k·∫øt):</h3>";
      notLearnedSubjectsDiv.innerHTML = "<h3>M√¥n ch∆∞a h·ªçc (nh·∫≠p t√™n, t√≠n ch·ªâ; ƒëi·ªÉm ƒë·ªÉ tr·ªëng):</h3>";

      // Restore and adjust learned subjects
      const learnedRows = Math.max(nLearned, learnedData.length);
      const newLearnedData = learnedData.slice(0, nLearned);
      for (let i = learnedData.length; i < nLearned; i++) {
        newLearnedData.push({ name: "", credit: "", score: "" });
      }
      restoreSubjectData(learnedSubjectsDiv, newLearnedData, true);

      // Restore and adjust unlearned subjects
      const newNotLearnedData = notLearnedData.slice(0, nNotLearned);
      for (let i = notLearnedData.length; i < nNotLearned; i++) {
        newNotLearnedData.push({ name: "", credit: "" });
      }
      restoreSubjectData(notLearnedSubjectsDiv, newNotLearnedData, false);

      // Show/hide unlearned subjects section
      notLearnedSubjectsDiv.style.display = nNotLearned > 0 ? "block" : "none";
      targetGpaInput.required = nNotLearned > 0;
      targetGpaInput.placeholder = nNotLearned > 0 ? "V√≠ d·ª•: 3.0 ho·∫∑c B+ (b·∫Øt bu·ªôc)" : "V√≠ d·ª•: 3.0 ho·∫∑c B+ (kh√¥ng b·∫Øt bu·ªôc)";

      subjectsForm.style.display = "block";
      return true;
    }

    generateBtn.addEventListener("click", () => {
      if (updateSubjectRows()) {
        resultDiv.innerHTML = "<canvas id='gpaChart'></canvas>";
        resultDiv.style.display = "none";
        if (chartInstance) chartInstance.destroy();
      }
    });

    subjectsForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const nLearned = parseInt(numLearnedInput.value) || 0;
      const nNotLearned = parseInt(numNotLearnedInput.value) || 0;

      const learnedRows = learnedSubjectsDiv.querySelectorAll(".subject-row");
      let totalPoints = 0;
      let totalCredits = 0;
      let error = false;

      let learnedSubjects = [];

      learnedRows.forEach((row, i) => {
        const inputs = row.querySelectorAll("input");
        const name = inputs[0].value.trim();
        const credit = parseFloat(inputs[1].value);
        const score = parseFloat(inputs[2].value);

        if (!name) {
          alert(`Vui l√≤ng nh·∫≠p t√™n m√¥n ƒë√£ h·ªçc th·ª© ${i + 1}`);
          error = true;
          return;
        }
        if (isNaN(credit) || credit <= 0) {
          alert(`Vui l√≤ng nh·∫≠p t√≠n ch·ªâ h·ª£p l·ªá cho m√¥n ƒë√£ h·ªçc th·ª© ${i + 1}`);
          error = true;
          return;
        }
        if (isNaN(score) || score < 0 || score > 10) {
          alert(`Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ªïng k·∫øt (0-10) h·ª£p l·ªá cho m√¥n ƒë√£ h·ªçc th·ª© ${i + 1}`);
          error = true;
          return;
        }

        const gpa4 = convert10To4(score);

        learnedSubjects.push({ name, credit, score, gpa4 });

        totalPoints += score * credit; // Use score (scale 10) for calculation
        totalCredits += credit;
      });

      if (error) return;

      let notLearnedSubjects = [];
      let totalCreditsNotLearned = 0;
      if (nNotLearned > 0) {
        const notLearnedRows = notLearnedSubjectsDiv.querySelectorAll(".subject-row");
        for (let i = 0; i < nNotLearned; i++) {
          const inputs = notLearnedRows[i].querySelectorAll("input");
          const name = inputs[0].value.trim();
          const credit = parseFloat(inputs[1].value);

          if (!name) {
            alert(`Vui l√≤ng nh·∫≠p t√™n m√¥n ch∆∞a h·ªçc th·ª© ${i + 1}`);
            error = true;
            break;
          }
          if (isNaN(credit) || credit <= 0) {
            alert(`Vui l√≤ng nh·∫≠p t√≠n ch·ªâ h·ª£p l·ªá cho m√¥n ch∆∞a h·ªçc th·ª© ${i + 1}`);
            error = true;
            break;
          }

          notLearnedSubjects.push({ name, credit });
          totalCreditsNotLearned += credit;
        }
        if (error) return;
      }

      const targetRaw = targetGpaInput.value.trim();
      let targetGpaNum = NaN;

      if (targetRaw === "" && nNotLearned > 0) {
        alert("Vui l√≤ng nh·∫≠p m·ª•c ti√™u GPA khi c√≥ m√¥n ch∆∞a h·ªçc.");
        return;
      } else if (targetRaw !== "") {
        targetGpaNum = parseFloat(targetRaw);
        if (isNaN(targetGpaNum)) {
          targetGpaNum = convertLetterToGPA(targetRaw);
        }
        if (isNaN(targetGpaNum) || targetGpaNum < 0 || targetGpaNum > 4) {
          alert("M·ª•c ti√™u GPA kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë t·ª´ 0 ƒë·∫øn 4 ho·∫∑c ch·ªØ nh∆∞ A+, A, B+,...");
          return;
        }
      }

      let html = "";

      if (totalCredits === 0) {
        html += "<p>B·∫°n ch∆∞a nh·∫≠p t√≠n ch·ªâ h·ª£p l·ªá cho c√°c m√¥n ƒë√£ h·ªçc.</p>";
        resultDiv.innerHTML = `<canvas id='gpaChart'></canvas>${html}`;
        resultDiv.style.display = "block";
        if (chartInstance) chartInstance.destroy();
        return;
      }

      // Calculate current GPA (on 4.0 scale)
      const currentGpaPoints = learnedSubjects.reduce((sum, subj) => sum + subj.gpa4 * subj.credit, 0);
      const currentGpa = currentGpaPoints / totalCredits;

      html += `<strong>GPA hi·ªán t·∫°i (m√¥n ƒë√£ h·ªçc):</strong> ${currentGpa.toFixed(2)} (${gpaLabel(currentGpa)})<br/>`;

      if (nNotLearned === 0) {
        resultDiv.innerHTML = `<canvas id='gpaChart'></canvas>${html}`;
        resultDiv.style.display = "block";
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('gpaChart').getContext('2d'), {
          type: 'pie',
          data: {
            labels: ['GPA Hi·ªán t·∫°i', 'C√≤n l·∫°i'],
            datasets: [{
              data: [currentGpa, 4.0 - currentGpa],
              backgroundColor: ['#4682b4', '#90EE90'],
              borderColor: ['#fff', '#fff'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: 'Ph√¢n b·ªë GPA' }
            }
          }
        });
        return;
      }

      // Calculate required score for unlearned subjects (on scale 10)
      const totalCreditsAll = totalCredits + totalCreditsNotLearned;

      // Map target GPA (4.0 scale) to equivalent score on 10 scale based on user-provided mapping
      let targetScore10;
      if (targetGpaNum >= 4.0) targetScore10 = 9.0;      // A+
      else if (targetGpaNum >= 3.8) targetScore10 = 8.5; // A
      else if (targetGpaNum >= 3.5) targetScore10 = 8.0; // B+
      else if (targetGpaNum >= 3.0) targetScore10 = 7.0; // B
      else if (targetGpaNum >= 2.5) targetScore10 = 6.0; // C+
      else if (targetGpaNum >= 2.0) targetScore10 = 5.5; // C
      else if (targetGpaNum >= 1.5) targetScore10 = 5.0; // D+
      else if (targetGpaNum >= 1.0) targetScore10 = 4.0; // D
      else targetScore10 = 2.5;                          // F

      // Solve for x: (totalPoints + x * totalCreditsNotLearned) / totalCreditsAll = targetScore10
      const totalPointsNeeded = targetScore10 * totalCreditsAll;
      const remainingPointsNeeded = totalPointsNeeded - totalPoints;
      const avgScoreNeeded = remainingPointsNeeded / totalCreditsNotLearned;

      if (avgScoreNeeded > 10 || avgScoreNeeded < 0) {
        html += `<p style="color:red;">Kh√¥ng th·ªÉ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u GPA ${targetGpaNum.toFixed(2)} (${gpaLabel(targetGpaNum)}) v·ªõi c√°c m√¥n ch∆∞a h·ªçc v√† t√≠n ch·ªâ hi·ªán t·∫°i.</p>`;
        resultDiv.innerHTML = `<canvas id='gpaChart'></canvas>${html}`;
        resultDiv.style.display = "block";
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('gpaChart').getContext('2d'), {
          type: 'pie',
          data: {
            labels: ['GPA Hi·ªán t·∫°i', 'C√≤n l·∫°i'],
            datasets: [{
              data: [currentGpa, 4.0 - currentGpa],
              backgroundColor: ['#4682b4', '#90EE90'],
              borderColor: ['#fff', '#fff'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: 'Ph√¢n b·ªë GPA' }
            }
          }
        });
        return;
      }

      html += `<strong>M·ª•c ti√™u GPA h·ªçc k·ª≥:</strong> ${targetGpaNum.toFixed(2)} (${gpaLabel(targetGpaNum)})<br/>`;
      html += `<strong>Chi ti·∫øt ƒëi·ªÉm c·∫ßn ƒë·∫°t t·ª´ng m√¥n ch∆∞a h·ªçc:</strong><ul>`;
      notLearnedSubjects.forEach((subj) => {
        const neededGpa = convert10To4(avgScoreNeeded);
        html += `<li><strong>${subj.name}</strong> (${subj.credit} t√≠n ch·ªâ): c·∫ßn ƒë·∫°t t·ªëi thi·ªÉu <strong>${avgScoreNeeded.toFixed(1)} ƒëi·ªÉm (thang 10)</strong> ho·∫∑c GPA ~${neededGpa.toFixed(2)} (${gpaLabel(neededGpa)})</li>`;
      });
      html += `</ul>`;

      resultDiv.innerHTML = `<canvas id='gpaChart'></canvas>${html}`;
      resultDiv.style.display = "block";
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(document.getElementById('gpaChart').getContext('2d'), {
        type: 'pie',
        data: {
          labels: ['GPA Hi·ªán t·∫°i', 'GPA C·∫ßn ƒë·∫°t'],
          datasets: [{
            data: [currentGpa, targetGpaNum - currentGpa],
            backgroundColor: ['#4682b4', '#90EE90'],
            borderColor: ['#fff', '#fff'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Ph√¢n b·ªë GPA' }
          }
        }
      });
    });
  </script>
</body>
</html>